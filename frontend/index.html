<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monte Carlo Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #F5F5F5;
            min-height: 100vh;
            padding: 20px;
            color: #2D2D2D;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #FFFFFF;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .header {
            background: #FFFFFF;
            border-bottom: 1px solid #E5E5E5;
            color: #2D2D2D;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            font-size: 1em;
            color: #5F5F5F;
        }

        .content {
            padding: 30px;
        }

        .step {
            background: #FFFFFF;
            border: 1px solid #E5E5E5;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            transition: box-shadow 0.2s;
        }

        .step:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .step h2 {
            color: #2D2D2D;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #2D2D2D;
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #E5E5E5;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
            background: #FFFFFF;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #C47C4A;
            box-shadow: 0 0 0 3px rgba(196, 124, 74, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        button {
            background: #C47C4A;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #B36B39;
            box-shadow: 0 2px 8px rgba(196, 124, 74, 0.3);
        }

        button:active {
            transform: translateY(1px);
        }

        button:disabled {
            background: #9B9B9B;
            cursor: not-allowed;
            box-shadow: none;
        }

        .inline-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #F8F8F8;
            border-radius: 6px;
            border: 1px solid #E5E5E5;
            transition: all 0.2s;
        }

        .checkbox-item:hover {
            background: #F0F0F0;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 400;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }

        .radio-item {
            display: flex;
            align-items: center;
        }

        .radio-item input[type="radio"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 400;
        }

        .variable-list {
            background: #F8F8F8;
            border: 1px solid #E5E5E5;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .variable-item {
            background: #FFFFFF;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid #E5E5E5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .variable-item:last-child {
            margin-bottom: 0;
        }

        .variable-info {
            color: #5F5F5F;
            font-size: 0.9em;
        }

        #status {
            background: #F8F8F8;
            border: 1px solid #E5E5E5;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            color: #5F5F5F;
        }

        #status.success {
            background: #E8F5E9;
            border-color: #52A574;
            color: #2E7D32;
        }

        #status.error {
            background: #FFEBEE;
            border-color: #D64949;
            color: #C62828;
        }

        .result-container {
            background: #F8F8F8;
            border: 1px solid #E5E5E5;
            border-radius: 6px;
            padding: 20px;
            margin-top: 15px;
        }

        .chart-image {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin: 10px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        pre {
            background: #F8F8F8;
            border: 1px solid #E0E0E0;
            border-radius: 6px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #383838;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        code {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #383838;
        }

        .collapsible {
            background: #F8F8F8;
            border: 1px solid #E5E5E5;
            border-radius: 6px;
            margin: 15px 0;
            overflow: hidden;
        }

        .collapsible-header {
            background: #FFFFFF;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #2D2D2D;
            transition: background 0.2s;
        }

        .collapsible-header:hover {
            background: #F5F5F5;
        }

        .collapsible-header::after {
            content: 'â–¼';
            font-size: 0.8em;
            transition: transform 0.2s;
        }

        .collapsible-header.active::after {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 15px;
        }

        .collapsible-content.show {
            max-height: 2000px;
            padding: 15px;
        }

        .example-section {
            margin: 10px 0;
        }

        .example-section h4 {
            color: #2D2D2D;
            margin: 15px 0 10px 0;
            font-size: 1em;
        }

        .example-code {
            background: #F8F8F8;
            border: 1px solid #E0E0E0;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }

        .help-text {
            color: #5F5F5F;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
            margin-left: 8px;
        }

        .badge-success {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .badge-info {
            background: #E3F2FD;
            color: #1976D2;
        }

        /* æœ¬åœ°çŠ¶æ€æç¤ºæ ·å¼ */
        .local-status {
            padding: 12px 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .local-status.info {
            background: #E3F2FD;
            border: 1px solid #90CAF9;
            color: #1565C0;
        }

        .local-status.success {
            background: #E8F5E9;
            border: 1px solid #52A574;
            color: #2E7D32;
        }

        .local-status.error {
            background: #FFEBEE;
            border: 1px solid #D64949;
            color: #C62828;
        }

        .local-status.warning {
            background: #FFF3E0;
            border: 1px solid #E5A854;
            color: #E65100;
        }

        /* åŠ è½½åŠ¨ç”» */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #C47C4A;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            flex-shrink: 0;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            width: 100%;
            background: #E5E5E5;
            border-radius: 10px;
            height: 24px;
            overflow: hidden;
            position: relative;
            margin: 8px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #C47C4A 0%, #B36B39 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85em;
            font-weight: 600;
        }

        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 24px;
            font-size: 0.85em;
            font-weight: 600;
            color: #2D2D2D;
            z-index: 1;
        }

        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid #E5E5E5;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 240px;
            z-index: 1000;
            overflow: hidden;
        }

        .dropdown-menu a {
            display: block;
            padding: 12px 16px;
            color: #2D2D2D;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s;
            border-bottom: 1px solid #F5F5F5;
        }

        .dropdown-menu a:last-child {
            border-bottom: none;
        }

        .dropdown-menu a:hover {
            background: #F5F5F5;
            color: #C47C4A;
        }

        .dropdown-menu a:active {
            background: #E5E5E5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ² Monte Carlo Simulator</h1>
            <p>Monte Carlo Simulation and Analysis</p>
        </div>

        <div class="content">
            <!-- Status Messages -->
            <div id="status" style="display: none;"></div>

            <!-- Step 1: Add Variables (JSON Only) -->
            <div class="step">
                <h2>Step 1: Add Variables (JSON Format)</h2>
                
                <!-- Collapsible Examples -->
                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        ğŸ“– Show Input Examples
                    </div>
                    <div class="collapsible-content">
                        <div class="example-section">
                            <h4>å­—æ®µè¯´æ˜</h4>
                            <div class="help-text">
                                <strong>å¿…å¡«å­—æ®µ:</strong>
                                <ul style="margin: 8px 0; padding-left: 20px;">
                                    <li><code>type</code>: "data" (ä½¿ç”¨å®æµ‹æ•°æ®) æˆ– "params" (ä½¿ç”¨ç»Ÿè®¡å‚æ•°)</li>
                                    <li><code>distribution</code>: "normal" (æ­£æ€åˆ†å¸ƒ) æˆ– "t" (tåˆ†å¸ƒ)</li>
                                </ul>
                                <strong>å¯é€‰å­—æ®µ:</strong>
                                <ul style="margin: 8px 0; padding-left: 20px;">
                                    <li><code>min_limit</code>, <code>max_limit</code>: é™åˆ¶é‡‡æ ·èŒƒå›´</li>
                                </ul>
                                <strong>Data ç±»å‹éœ€è¦:</strong> <code>values</code> (æ•°ç»„)
                                <br>
                                <strong>Params ç±»å‹éœ€è¦:</strong> <code>mean</code>, <code>std</code>; å¦‚æœæ˜¯ t åˆ†å¸ƒè¿˜éœ€è¦ <code>df</code> (è‡ªç”±åº¦)
                            </div>

                            <h4>ç¤ºä¾‹ 1: å®æµ‹æ•°æ® + æ­£æ€åˆ†å¸ƒ</h4>
                            <div class="example-code">
<pre><code>{
  "æµ‹é‡A": {
    "type": "data",
    "values": [10.5, 11.2, 9.8, 10.1, 10.7, 11.0, 10.3],
    "distribution": "normal"
  },
  "ç†è®ºB": {
    "type": "params",
    "mean": 100,
    "std": 5,
    "distribution": "normal"
  }
}</code></pre>
                            </div>

                            <h4>ç¤ºä¾‹ 2: å¸¦é™å€¼çš„ç»„åˆ</h4>
                            <div class="example-code">
<pre><code>{
  "æ¸©åº¦": {
    "type": "data",
    "values": [20.1, 20.5, 19.8, 20.3, 20.2, 19.9, 20.4],
    "distribution": "normal",
    "min_limit": 15,
    "max_limit": 25
  },
  "å‹åŠ›": {
    "type": "params",
    "mean": 100,
    "std": 5,
    "distribution": "normal",
    "min_limit": 85,
    "max_limit": 115
  }
}</code></pre>
                            </div>

                            <h4>ç¤ºä¾‹ 3: ä½¿ç”¨ t åˆ†å¸ƒ</h4>
                            <div class="example-code">
<pre><code>{
  "å°æ ·æœ¬æ•°æ®": {
    "type": "data",
    "values": [50.2, 49.8, 50.5, 50.1, 50.3],
    "distribution": "t"
  },
  "å‚æ•°ä¼°è®¡": {
    "type": "params",
    "mean": 50,
    "std": 2,
    "df": 10,
    "distribution": "t",
    "min_limit": 40,
    "max_limit": 60
  }
}</code></pre>
                            </div>

                            <h4>ç¤ºä¾‹ 4: å®Œæ•´æ¡ˆä¾‹ï¼ˆæ··åˆä½¿ç”¨ï¼‰</h4>
                            <div class="example-code">
<pre><code>{
  "var_A": {
    "type": "data",
    "values": [10.5, 11.2, 9.8, 10.1, 10.7, 11.0, 10.3, 10.8],
    "distribution": "normal",
    "min_limit": 8,
    "max_limit": 13
  },
  "var_B": {
    "type": "params",
    "mean": 100,
    "std": 5,
    "distribution": "normal"
  },
  "var_C": {
    "type": "params",
    "mean": 50,
    "std": 2,
    "df": 15,
    "distribution": "t",
    "min_limit": 45,
    "max_limit": 55
  }
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="jsonInput">JSON Variable Definition</label>
                    <textarea id="jsonInput" placeholder='Paste JSON format variable definition...'></textarea>
                    <div class="help-text">Paste JSON format variable definition, click "Show Input Examples" above to view examples</div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="addVariablesFromJson()">Add Variables from JSON</button>
                    <div id="addVariableStatus" style="display: none; flex: 1; min-width: 300px;"></div>
                </div>

                <div id="variableList" class="variable-list" style="display: none;">
                    <strong>Added Variables:</strong>
                    <div id="variableItems"></div>
                </div>
            </div>

            <!-- Step 2: Define Function -->
            <div class="step">
                <h2>Step 2: Define Function</h2>

                <!-- Collapsible Formula Examples -->
                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        ğŸ“– Show Formula Examples
                    </div>
                    <div class="collapsible-content">
                        <div class="example-section">
                            <h4>ç¤ºä¾‹ 1: ç®€å•ç®—æœ¯è¿ç®—</h4>
                            <div class="example-code">
<pre><code>def custom_formula(vars):
    """ç®€å•çš„åŠ æƒæ±‚å’Œ"""
    return vars['æ¸©åº¦'] * 0.6 + vars['å‹åŠ›'] * 0.4</code></pre>
                            </div>

                            <h4>ç¤ºä¾‹ 2: ä½¿ç”¨ NumPy æ•°å­¦å‡½æ•°</h4>
                            <div class="example-code">
<pre><code>def custom_formula(vars):
    """ä½¿ç”¨æ•°å­¦å‡½æ•°è®¡ç®—"""
    import numpy as np
    A = vars['var_A']
    B = vars['var_B']
    return np.sqrt(A**2 + B**2)</code></pre>
                            </div>

                            <h4>ç¤ºä¾‹ 3: æ¡ä»¶åˆ¤æ–­</h4>
                            <div class="example-code">
<pre><code>def custom_formula(vars):
    """æ ¹æ®æ¡ä»¶è®¡ç®—ä¸åŒç»“æœ"""
    import numpy as np
    temp = vars['æ¸©åº¦']
    press = vars['å‹åŠ›']
    # æ¸©åº¦å¤§äº20æ—¶ç”¨ä¹˜æ³•ï¼Œå¦åˆ™ç”¨åŠ æ³•
    return np.where(temp > 20, temp * press, temp + press)</code></pre>
                            </div>

                            <h4>ç¤ºä¾‹ 4: å·¥ç¨‹è®¡ç®—å…¬å¼</h4>
                            <div class="example-code">
<pre><code>def custom_formula(vars):
    """ç†æƒ³æ°”ä½“çŠ¶æ€æ–¹ç¨‹ PV = nRT"""
    import numpy as np
    T = vars['æ¸©åº¦']  # æ¸©åº¦ (æ‘„æ°åº¦)
    P = vars['å‹åŠ›']  # å‹åŠ› (Pa)
    F = vars['æµé‡']  # æµé‡
    R = 8.314  # æ°”ä½“å¸¸æ•°
    # è½¬æ¢ä¸ºå¼€å°”æ–‡æ¸©åº¦
    T_kelvin = T + 273.15
    return (P * F) / (T_kelvin * R)</code></pre>
                            </div>

                            <h4>ç¤ºä¾‹ 5: å¤šæ­¥éª¤å¤æ‚è®¡ç®—</h4>
                            <div class="example-code">
<pre><code>def custom_formula(vars):
    """åˆ†æ­¥éª¤çš„å¤æ‚è®¡ç®—ç¤ºä¾‹"""
    import numpy as np
    
    # ç¬¬ä¸€æ­¥ï¼šæ•°æ®æ ‡å‡†åŒ–
    A_normalized = (vars['var_A'] - 100) / 10
    B_normalized = (vars['var_B'] - 50) / 5
    
    # ç¬¬äºŒæ­¥ï¼šç»„åˆè®¡ç®—
    combined = A_normalized * B_normalized
    
    # ç¬¬ä¸‰æ­¥ï¼šSigmoid å˜æ¢
    result = np.exp(combined) / (1 + np.exp(combined))
    
    return result</code></pre>
                            </div>

                            <div class="help-text" style="margin-top: 15px;">
                                <strong>å¯ç”¨çš„æ•°å­¦å‡½æ•°:</strong> numpy (as np), sin, cos, tan, exp, log, log10, ln, sqrt, abs, pow
                            </div>
                        </div>
                    </div>
                </div>

                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="simpleFormula" name="formulaType" value="simple" checked>
                        <label for="simpleFormula">Simple Formula</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="advancedFormula" name="formulaType" value="advanced">
                        <label for="advancedFormula">Advanced (Python Function)</label>
                    </div>
                </div>

                <div id="simpleFormulaDiv">
                    <div class="form-group">
                        <label for="formula">Formula</label>
                        <input type="text" id="formula" placeholder="e.g., var_A + var_B * var_C">
                        <div class="help-text">Use variable names directly in the formula</div>
                    </div>
                </div>

                <div id="advancedFormulaDiv" style="display: none;">
                    <div class="form-group">
                        <label for="customFunction">Custom Python Function</label>
                        <textarea id="customFunction" placeholder="def custom_formula(vars):&#10;    import numpy as np&#10;    return vars['var_A'] + vars['var_B']"></textarea>
                        <div class="help-text">Function must be named 'custom_formula' and accept 'vars' dict parameter</div>
                    </div>
                </div>

                <div class="inline-fields">
                    <div class="form-group">
                        <label for="resultName">Result Name</label>
                        <input type="text" id="resultName" value="result">
                    </div>
                    <div class="form-group">
                        <label for="nSamples">Number of Samples</label>
                        <input type="number" id="nSamples" value="1000000" min="1000">
                    </div>
                    <div class="form-group">
                        <label for="cdfDegree">CDF Fit Degree</label>
                        <input type="number" id="cdfDegree" value="5" min="1" max="10">
                        <div class="help-text">Polynomial fit degree (1-10)</div>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="runSimulation()">Run Simulation</button>
                    <div id="simulationStatus" style="display: none; flex: 1; min-width: 300px;"></div>
                </div>
            </div>

            <!-- Step 3: Generate Charts -->
            <div class="step">
                <h2>Step 3: Generate Charts</h2>
                
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="chartResultPlot" value="result_plot" checked>
                        <label for="chartResultPlot">Result Distribution Plot</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="chartVarDist" value="var_distributions">
                        <label for="chartVarDist">Variable Distributions</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="chartPareto" value="pareto">
                        <label for="chartPareto">Pareto Chart</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="chartTornado" value="tornado">
                        <label for="chartTornado">Tornado Chart</label>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="generateCharts()">Generate Selected Charts</button>
                    <div id="chartStatus" style="display: none; flex: 1; min-width: 300px;"></div>
                </div>

                <div id="chartResults" class="result-container" style="display: none;"></div>
            </div>

            <!-- Step 4: Analysis & Download -->
            <div class="step">
                <h2>Step 4: Analysis & Download</h2>
                
                <div class="help-text" style="margin-bottom: 15px;">
                    Generate analysis report and download simulation data
                </div>

                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="generateReport()">Generate Report</button>
                    
                    <!-- ä¸‹è½½æŒ‰é’®ä¸‹æ‹‰èœå• -->
                    <div style="position: relative;">
                        <button id="downloadBtn" onclick="toggleDownloadMenu()" style="background: #52A574; display: flex; align-items: center; gap: 8px;">
                            ğŸ“¥ Download Data
                            <span style="font-size: 0.8em;">â–¼</span>
                        </button>
                        <div id="downloadMenu" class="dropdown-menu" style="display: none;">
                            <a href="#" onclick="downloadCSV(); return false;">ğŸ“„ Raw Data (CSV)</a>
                            <a href="#" onclick="downloadJSON(); return false;">ğŸ“‹ Raw Data (JSON)</a>
                            <a href="#" onclick="downloadReport(); return false;">ğŸ“Š Analysis Report</a>
                            <a href="#" onclick="downloadFull(); return false;">ğŸ“¦ Full Report with Charts</a>
                        </div>
                    </div>
                    
                    <div id="reportStatus" style="display: none; flex: 1; min-width: 300px;"></div>
                </div>

                <div id="reportResult" class="result-container" style="display: none;"></div>
            </div>

            <!-- Reset Button -->
            <div class="step">
                <h2>Reset Simulator</h2>
                <button onclick="resetSimulator()" style="background: #D64949;">Reset All Data</button>
            </div>
        </div>
    </div>

    <script>
        // æ˜¾ç¤ºæœ¬åœ°çŠ¶æ€ï¼ˆåœ¨ç‰¹å®šåŒºåŸŸï¼‰
        function showLocalStatus(elementId, message, type = 'info', showSpinner = false) {
            const statusDiv = document.getElementById(elementId);
            
            let spinnerHtml = '';
            if (showSpinner) {
                spinnerHtml = '<div class="spinner"></div>';
            }
            
            statusDiv.innerHTML = `${spinnerHtml}<span>${message}</span>`;
            statusDiv.className = `local-status ${type}`;
            statusDiv.style.display = 'flex';
        }

        // éšè—æœ¬åœ°çŠ¶æ€
        function hideLocalStatus(elementId) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.style.display = 'none';
        }

        // Toggle collapsible sections
        function toggleCollapsible(header) {
            header.classList.toggle('active');
            const content = header.nextElementSibling;
            content.classList.toggle('show');
        }

        // Toggle formula input type
        document.querySelectorAll('input[name="formulaType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'simple') {
                    document.getElementById('simpleFormulaDiv').style.display = 'block';
                    document.getElementById('advancedFormulaDiv').style.display = 'none';
                } else {
                    document.getElementById('simpleFormulaDiv').style.display = 'none';
                    document.getElementById('advancedFormulaDiv').style.display = 'block';
                }
            });
        });

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        function addVariablesFromJson() {
            const jsonInput = document.getElementById('jsonInput').value.trim();
            
            if (!jsonInput) {
                showLocalStatus('addVariableStatus', 'Please enter JSON variable definition', 'error', false);
                showStatus('Please enter JSON variable definition', 'error');
                return;
            }

            // Show loading state
            showLocalStatus('addVariableStatus', 'Adding variables...', 'info', true);
            showStatus('Adding variables...', 'info');

            fetch('/api/add_variables_json', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ variables: jsonInput })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showLocalStatus('addVariableStatus', `âœ… Successfully added ${Object.keys(JSON.parse(jsonInput)).length} variable(s)`, 'success', false);
                    showStatus(data.message, 'success');
                    updateVariableList(data.variables);
                } else {
                    showLocalStatus('addVariableStatus', 'âŒ Error: ' + data.error, 'error', false);
                    showStatus('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showLocalStatus('addVariableStatus', 'âŒ Request failed: ' + error.message, 'error', false);
                showStatus('Request failed: ' + error.message, 'error');
            });
        }

        function updateVariableList(variables) {
            const listDiv = document.getElementById('variableList');
            const itemsDiv = document.getElementById('variableItems');
            
            if (Object.keys(variables).length === 0) {
                listDiv.style.display = 'none';
                return;
            }

            listDiv.style.display = 'block';
            itemsDiv.innerHTML = '';

            for (const [name, info] of Object.entries(variables)) {
                const item = document.createElement('div');
                item.className = 'variable-item';
                
                let paramStr = '';
                if (info.dist_type === 'norm' || info.dist_type === 'normal') {
                    paramStr = `Î¼=${info.dist_params[0].toFixed(3)}, Ïƒ=${info.dist_params[1].toFixed(3)}`;
                } else if (info.dist_type === 't') {
                    paramStr = `df=${info.dist_params[0].toFixed(1)}, loc=${info.dist_params[1].toFixed(3)}, scale=${info.dist_params[2].toFixed(3)}`;
                }

                // Format range
                let rangeStr = '';
                const minVal = info.min_value;
                const maxVal = info.max_value;
                
                if (minVal === null && maxVal === null) {
                    rangeStr = '(-âˆ, +âˆ)';
                } else if (minVal === null) {
                    rangeStr = `(-âˆ, ${maxVal.toFixed(3)}]`;
                } else if (maxVal === null) {
                    rangeStr = `[${minVal.toFixed(3)}, +âˆ)`;
                } else {
                    rangeStr = `[${minVal.toFixed(3)}, ${maxVal.toFixed(3)}]`;
                }

                item.innerHTML = `
                    <div>
                        <strong>${name}</strong>
                        <span class="badge badge-info">${info.dist_type}</span>
                    </div>
                    <div class="variable-info">${paramStr}</div>
                    <div class="variable-info" style="color: #666; font-size: 0.9em;">Range: ${rangeStr}</div>
                `;
                itemsDiv.appendChild(item);
            }
        }

        function runSimulation() {
            const formulaType = document.querySelector('input[name="formulaType"]:checked').value;
            const resultName = document.getElementById('resultName').value;
            const nSamples = parseInt(document.getElementById('nSamples').value);
            const cdfDegree = parseInt(document.getElementById('cdfDegree').value);

            let requestData = {
                result_name: resultName,
                n_samples: nSamples,
                cdf_fit_degree: cdfDegree
            };

            if (formulaType === 'simple') {
                requestData.formula = document.getElementById('formula').value;
                requestData.use_custom_function = false;
            } else {
                requestData.custom_function_code = document.getElementById('customFunction').value;
                requestData.use_custom_function = true;
            }

            // Estimate running time (based on sample count)
            // Assume ~1 second per 500,000 samples
            const estimatedTime = Math.max(2, (nSamples / 500000));

            // Show progress bar
            const statusHtml = `
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; font-size: 0.9em; color: #5F5F5F;">
                        Running simulation... (${nSamples.toLocaleString()} samples)
                    </div>
                    <div class="progress-container">
                        <div class="progress-text" id="progressText">0%</div>
                        <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                    </div>
                </div>
            `;
            
            const statusDiv = document.getElementById('simulationStatus');
            statusDiv.innerHTML = statusHtml;
            statusDiv.className = 'local-status info';
            statusDiv.style.display = 'flex';

            showStatus('Simulation in progress, please wait...', 'info');

            // Progress bar animation
            let progress = 0;
            const progressInterval = setInterval(() => {
                // Use non-linear growth (fast at start, slow at end)
                if (progress < 30) {
                    progress += 2;
                } else if (progress < 60) {
                    progress += 1;
                } else if (progress < 90) {
                    progress += 0.5;
                } else if (progress < 95) {
                    progress += 0.2;
                }
                
                progress = Math.min(progress, 95); // Max 95%, wait for actual completion
                
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                if (progressBar && progressText) {
                    progressBar.style.width = progress + '%';
                    progressText.textContent = Math.floor(progress) + '%';
                }
            }, estimatedTime * 1000 / 50); // Update in 50 steps

            const startTime = Date.now();

            fetch('/api/run_simulation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                
                if (data.success) {
                    // Set to 100% when complete
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    if (progressBar && progressText) {
                        progressBar.style.width = '100%';
                        progressText.textContent = '100%';
                    }
                    
                    // Show success message after 0.3s delay
                    setTimeout(() => {
                        showLocalStatus('simulationStatus', 
                            `âœ… Simulation complete! Time: ${duration}s | Samples: ${nSamples.toLocaleString()} | CDF degree: ${cdfDegree}`, 
                            'success', false);
                    }, 300);
                    
                    showStatus(`Simulation completed successfully in ${duration}s`, 'success');
                } else {
                    showLocalStatus('simulationStatus', 'âŒ Error: ' + data.error, 'error', false);
                    showStatus('Simulation failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                showLocalStatus('simulationStatus', 'âŒ Request failed: ' + error.message, 'error', false);
                showStatus('Request failed: ' + error.message, 'error');
            });
        }

        function generateCharts() {
            const chartTypes = [];
            document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked').forEach(cb => {
                chartTypes.push(cb.value);
            });

            if (chartTypes.length === 0) {
                showLocalStatus('chartStatus', 'âš ï¸ Please select at least one chart type', 'warning', false);
                return;
            }

            // Show loading state
            showLocalStatus('chartStatus', `Generating ${chartTypes.length} chart(s)...`, 'info', true);
            showStatus('Generating charts, please wait...', 'info');

            const startTime = Date.now();

            fetch('/api/generate_charts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chart_types: chartTypes })
            })
            .then(response => response.json())
            .then(data => {
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                
                if (data.success) {
                    showLocalStatus('chartStatus', `âœ… Charts generated! Time: ${duration}s`, 'success', false);
                    showStatus(`Successfully generated ${chartTypes.length} chart(s)`, 'success');
                    displayCharts(data.charts);
                } else {
                    showLocalStatus('chartStatus', 'âŒ Error: ' + data.error, 'error', false);
                    showStatus('Chart generation failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showLocalStatus('chartStatus', 'âŒ Request failed: ' + error.message, 'error', false);
                showStatus('Request failed: ' + error.message, 'error');
            });
        }

        function displayCharts(charts) {
            const resultsDiv = document.getElementById('chartResults');
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'block';

            if (charts.result_plot) {
                const title = document.createElement('h3');
                title.textContent = 'Result Distribution';
                title.style.marginTop = '20px';
                resultsDiv.appendChild(title);

                const img = document.createElement('img');
                img.src = 'data:image/png;base64,' + charts.result_plot;
                img.className = 'chart-image';
                resultsDiv.appendChild(img);
            }

            if (charts.var_distributions) {
                const title = document.createElement('h3');
                title.textContent = 'Variable Distributions';
                title.style.marginTop = '20px';
                resultsDiv.appendChild(title);

                for (const [varName, imgData] of Object.entries(charts.var_distributions)) {
                    const varTitle = document.createElement('h4');
                    varTitle.textContent = varName;
                    varTitle.style.marginTop = '15px';
                    resultsDiv.appendChild(varTitle);

                    const img = document.createElement('img');
                    img.src = 'data:image/png;base64,' + imgData;
                    img.className = 'chart-image';
                    resultsDiv.appendChild(img);
                }
            }

            if (charts.pareto) {
                const title = document.createElement('h3');
                title.textContent = 'Pareto Chart';
                title.style.marginTop = '20px';
                resultsDiv.appendChild(title);

                const img = document.createElement('img');
                img.src = 'data:image/png;base64,' + charts.pareto;
                img.className = 'chart-image';
                resultsDiv.appendChild(img);
            }

            if (charts.tornado) {
                const title = document.createElement('h3');
                title.textContent = 'Tornado Chart';
                title.style.marginTop = '20px';
                resultsDiv.appendChild(title);

                const img = document.createElement('img');
                img.src = 'data:image/png;base64,' + charts.tornado;
                img.className = 'chart-image';
                resultsDiv.appendChild(img);
            }
        }

        function generateReport() {
            // Show loading state
            showLocalStatus('reportStatus', 'Generating report...', 'info', true);
            showStatus('Generating report, please wait...', 'info');

            const startTime = Date.now();

            fetch('/api/generate_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                
                if (data.success) {
                    showLocalStatus('reportStatus', `âœ… Report generated! Time: ${duration}s`, 'success', false);
                    showStatus('Report generated successfully', 'success');
                    displayReport(data.report);
                } else {
                    showLocalStatus('reportStatus', 'âŒ Error: ' + data.error, 'error', false);
                    showStatus('Report generation failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showLocalStatus('reportStatus', 'âŒ Request failed: ' + error.message, 'error', false);
                showStatus('Request failed: ' + error.message, 'error');
            });
        }

        function displayReport(report) {
            const resultsDiv = document.getElementById('reportResult');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<pre>' + report + '</pre>';
        }

        function resetSimulator() {
            if (!confirm('Are you sure you want to reset all data?')) {
                return;
            }

            showStatus('Resetting...', 'info');

            fetch('/api/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('Simulator reset successfully', 'success');
                    document.getElementById('jsonInput').value = '';
                    document.getElementById('variableList').style.display = 'none';
                    document.getElementById('chartResults').style.display = 'none';
                    document.getElementById('reportResult').style.display = 'none';
                    
                    // Hide all local status
                    hideLocalStatus('addVariableStatus');
                    hideLocalStatus('simulationStatus');
                    hideLocalStatus('chartStatus');
                    hideLocalStatus('reportStatus');
                } else {
                    showStatus('Reset failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showStatus('Request failed: ' + error.message, 'error');
            });
        }

        // ==================== ä¸‹è½½åŠŸèƒ½ ====================
        
        // åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤º
        function toggleDownloadMenu() {
            const menu = document.getElementById('downloadMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', function(event) {
            const btn = document.getElementById('downloadBtn');
            const menu = document.getElementById('downloadMenu');
            if (btn && menu && !btn.contains(event.target) && !menu.contains(event.target)) {
                menu.style.display = 'none';
            }
        });

        // é€šç”¨ä¸‹è½½å‡½æ•°
        async function downloadFile(endpoint, filename) {
            showLocalStatus('reportStatus', 'ğŸ“¥ Preparing download...', 'info', true);
            showStatus('Preparing download, please wait...', 'info');

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Download failed');
                }

                // è·å–æ–‡ä»¶ blob
                const blob = await response.blob();
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename || 'download.zip';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showLocalStatus('reportStatus', 'âœ… Download complete!', 'success', false);
                showStatus('Download completed successfully', 'success');
                
                // 3ç§’åéšè—çŠ¶æ€
                setTimeout(() => {
                    hideLocalStatus('reportStatus');
                }, 3000);

            } catch (error) {
                showLocalStatus('reportStatus', 'âŒ Download failed: ' + error.message, 'error', false);
                showStatus('Download failed: ' + error.message, 'error');
            }

            // å…³é—­ä¸‹æ‹‰èœå•
            document.getElementById('downloadMenu').style.display = 'none';
        }

        // ä¸‹è½½ CSV
        function downloadCSV() {
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
            downloadFile('/api/download_csv_zip', `monte_carlo_data_csv_${timestamp}.zip`);
        }

        // ä¸‹è½½ JSON
        function downloadJSON() {
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
            downloadFile('/api/download_json_zip', `monte_carlo_data_json_${timestamp}.zip`);
        }

        // ä¸‹è½½æŠ¥å‘Š
        function downloadReport() {
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
            downloadFile('/api/download_report_zip', `monte_carlo_report_${timestamp}.zip`);
        }

        // ä¸‹è½½å®Œæ•´åŒ…
        function downloadFull() {
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
            downloadFile('/api/download_full_zip', `monte_carlo_full_${timestamp}.zip`);
        }
    </script>
</body>
</html>
