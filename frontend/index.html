<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monte Carlo Simulator</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎲 Monte Carlo Simulator</h1>
            <p>Monte Carlo Simulation and Analysis</p>
        </div>

        <div class="content">
            <!-- Status Messages -->
            <div id="status" style="display: none;"></div>

            <!-- Step 1: Add Variables (JSON Only) -->
            <div class="step">
                <h2>Step 1: Add Variables (JSON Format)</h2>
                
                <!-- Collapsible Examples -->
                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        📖 Show Input Examples
                    </div>
                    <div class="collapsible-content">
                        <div class="example-section">
                            <h4>字段说明</h4>
                            <div class="help-text">
                                <strong>必填字段:</strong>
                                <ul style="margin: 8px 0; padding-left: 20px;">
                                    <li><code>type</code>: "data" (使用实测数据) 或 "params" (使用统计参数)</li>
                                    <li><code>distribution</code>: "normal" (正态分布) 或 "t" (t分布)</li>
                                </ul>
                                <strong>可选字段:</strong>
                                <ul style="margin: 8px 0; padding-left: 20px;">
                                    <li><code>min_limit</code>, <code>max_limit</code>: 限制采样范围</li>
                                </ul>
                                <strong>Data 类型需要:</strong> <code>values</code> (数组)
                                <br>
                                <strong>Params 类型需要:</strong> <code>mean</code>, <code>std</code>; 如果是 t 分布还需要 <code>df</code> (自由度)
                            </div>

                            <h4>示例 1: 实测数据 + 正态分布</h4>
                            <div class="example-code">
<pre><code>{
  "测量A": {
    "type": "data",
    "values": [10.5, 11.2, 9.8, 10.1, 10.7, 11.0, 10.3],
    "distribution": "normal"
  },
  "理论B": {
    "type": "params",
    "mean": 100,
    "std": 5,
    "distribution": "normal"
  }
}</code></pre>
                            </div>

                            <h4>示例 2: 带限值的组合</h4>
                            <div class="example-code">
<pre><code>{
  "温度": {
    "type": "data",
    "values": [20.1, 20.5, 19.8, 20.3, 20.2, 19.9, 20.4],
    "distribution": "normal",
    "min_limit": 15,
    "max_limit": 25
  },
  "压力": {
    "type": "params",
    "mean": 100,
    "std": 5,
    "distribution": "normal",
    "min_limit": 85,
    "max_limit": 115
  }
}</code></pre>
                            </div>

                            <h4>示例 3: 使用 t 分布</h4>
                            <div class="example-code">
<pre><code>{
  "小样本数据": {
    "type": "data",
    "values": [50.2, 49.8, 50.5, 50.1, 50.3],
    "distribution": "t"
  },
  "参数估计": {
    "type": "params",
    "mean": 50,
    "std": 2,
    "df": 10,
    "distribution": "t",
    "min_limit": 40,
    "max_limit": 60
  }
}</code></pre>
                            </div>

                            <h4>示例 4: 完整案例（混合使用）</h4>
                            <div class="example-code">
<pre><code>{
  "var_A": {
    "type": "data",
    "values": [10.5, 11.2, 9.8, 10.1, 10.7, 11.0, 10.3, 10.8],
    "distribution": "normal",
    "min_limit": 8,
    "max_limit": 13
  },
  "var_B": {
    "type": "params",
    "mean": 100,
    "std": 5,
    "distribution": "normal"
  },
  "var_C": {
    "type": "params",
    "mean": 50,
    "std": 2,
    "df": 15,
    "distribution": "t",
    "min_limit": 45,
    "max_limit": 55
  }
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="jsonInput">JSON Variable Definition</label>
                    <textarea id="jsonInput" placeholder='Paste JSON format variable definition...'></textarea>
                    <div class="help-text">Paste JSON format variable definition, click "Show Input Examples" above to view examples</div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="addVariablesFromJson()">Add Variables from JSON</button>
                    <div id="addVariableStatus" style="display: none; flex: 1; min-width: 300px;"></div>
                </div>

                <div id="variableList" class="variable-list" style="display: none;">
                    <strong>Added Variables:</strong>
                    <div id="variableItems"></div>
                </div>
            </div>

            <!-- Step 2: Define Function -->
            <div class="step">
                <h2>Step 2: Define Function</h2>

                <!-- Collapsible Formula Examples -->
                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        📖 Show Formula Examples
                    </div>
                    <div class="collapsible-content">
                        <div class="example-section">
                            <h4>示例 1: 简单算术运算</h4>
                            <div class="example-code">
<pre><code>def custom_formula(vars):
    """简单的加权求和"""
    return vars['温度'] * 0.6 + vars['压力'] * 0.4</code></pre>
                            </div>

                            <h4>示例 2: 使用 NumPy 数学函数</h4>
                            <div class="example-code">
<pre><code>def custom_formula(vars):
    """使用数学函数计算"""
    import numpy as np
    A = vars['var_A']
    B = vars['var_B']
    return np.sqrt(A**2 + B**2)</code></pre>
                            </div>

                            <h4>示例 3: 条件判断</h4>
                            <div class="example-code">
<pre><code>def custom_formula(vars):
    """根据条件计算不同结果"""
    import numpy as np
    temp = vars['温度']
    press = vars['压力']
    # 温度大于20时用乘法，否则用加法
    return np.where(temp > 20, temp * press, temp + press)</code></pre>
                            </div>

                            <h4>示例 4: 工程计算公式</h4>
                            <div class="example-code">
<pre><code>def custom_formula(vars):
    """理想气体状态方程 PV = nRT"""
    import numpy as np
    T = vars['温度']  # 温度 (摄氏度)
    P = vars['压力']  # 压力 (Pa)
    F = vars['流量']  # 流量
    R = 8.314  # 气体常数
    # 转换为开尔文温度
    T_kelvin = T + 273.15
    return (P * F) / (T_kelvin * R)</code></pre>
                            </div>

                            <h4>示例 5: 多步骤复杂计算</h4>
                            <div class="example-code">
<pre><code>def custom_formula(vars):
    """分步骤的复杂计算示例"""
    import numpy as np
    
    # 第一步：数据标准化
    A_normalized = (vars['var_A'] - 100) / 10
    B_normalized = (vars['var_B'] - 50) / 5
    
    # 第二步：组合计算
    combined = A_normalized * B_normalized
    
    # 第三步：Sigmoid 变换
    result = np.exp(combined) / (1 + np.exp(combined))
    
    return result</code></pre>
                            </div>

                            <div class="help-text" style="margin-top: 15px;">
                                <strong>可用的数学函数:</strong> numpy (as np), sin, cos, tan, exp, log, log10, ln, sqrt, abs, pow
                            </div>
                        </div>
                    </div>
                </div>

                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="simpleFormula" name="formulaType" value="simple" checked>
                        <label for="simpleFormula">Simple Formula</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="advancedFormula" name="formulaType" value="advanced">
                        <label for="advancedFormula">Advanced (Python Function)</label>
                    </div>
                </div>

                <div id="simpleFormulaDiv">
                    <div class="form-group">
                        <label for="formula">Formula</label>
                        <input type="text" id="formula" placeholder="e.g., var_A + var_B * var_C">
                        <div class="help-text">Use variable names directly in the formula</div>
                    </div>
                </div>

                <div id="advancedFormulaDiv" style="display: none;">
                    <div class="form-group">
                        <label for="customFunction">Custom Python Function</label>
                        <textarea id="customFunction" placeholder="def custom_formula(vars):&#10;    import numpy as np&#10;    return vars['var_A'] + vars['var_B']"></textarea>
                        <div class="help-text">Function must be named 'custom_formula' and accept 'vars' dict parameter</div>
                    </div>
                </div>

                <div class="inline-fields">
                    <div class="form-group">
                        <label for="resultName">Result Name</label>
                        <input type="text" id="resultName" value="result">
                    </div>
                    <div class="form-group">
                        <label for="nSamples">Number of Samples</label>
                        <input type="number" id="nSamples" value="1000000" min="1000">
                    </div>
                    <div class="form-group">
                        <label for="cdfDegree">CDF Fit Degree</label>
                        <input type="number" id="cdfDegree" value="8" min="1" max="30">
                        <div class="help-text">Polynomial fit degree (1-30)</div>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="runSimulation()">Run Simulation</button>
                    <div id="simulationStatus" style="display: none; flex: 1; min-width: 300px;"></div>
                </div>
            </div>

            <!-- Step 3: Generate Charts -->
            <div class="step">
                <h2>Step 3: Generate Charts</h2>
                
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="chartResultPlot" value="result_plot" checked>
                        <label for="chartResultPlot">Result Distribution Plot</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="chartVarDist" value="var_distributions">
                        <label for="chartVarDist">Variable Distributions</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="chartPareto" value="pareto">
                        <label for="chartPareto">Pareto Chart</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="chartTornado" value="tornado">
                        <label for="chartTornado">Tornado Chart</label>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="generateCharts()">Generate Selected Charts</button>
                    <div id="chartStatus" style="display: none; flex: 1; min-width: 300px;"></div>
                </div>

                <div id="chartResults" class="result-container" style="display: none;"></div>
            </div>

            <!-- Step 4: Analysis & Download -->
            <div class="step">
                <h2>Step 4: Analysis & Download</h2>
                
                <div class="help-text" style="margin-bottom: 15px;">
                    Generate analysis report and download simulation data
                </div>

                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="generateReport()">Generate Report</button>
                    
                    <!-- 下载按钮下拉菜单 -->
                    <div style="position: relative;">
                        <button id="downloadBtn" onclick="toggleDownloadMenu()" style="background: #52A574; display: flex; align-items: center; gap: 8px;">
                            📥 Download Data
                            <span style="font-size: 0.8em;">▼</span>
                        </button>
                        <div id="downloadMenu" class="dropdown-menu" style="display: none;">
                            <a href="#" onclick="downloadCSV(); return false;">📄 Raw Data (CSV)</a>
                            <a href="#" onclick="downloadJSON(); return false;">📋 Raw Data (JSON)</a>
                            <a href="#" onclick="downloadReport(); return false;">📊 Analysis Report</a>
                            <a href="#" onclick="downloadFull(); return false;">📦 Full Report with Charts</a>
                        </div>
                    </div>
                    
                    <div id="reportStatus" style="display: none; flex: 1; min-width: 300px;"></div>
                </div>

                <div id="reportResult" class="result-container" style="display: none;"></div>
            </div>

            <!-- Reset Button -->
            <div class="step">
                <h2>Reset Simulator</h2>
                <button onclick="resetSimulator()" style="background: #D64949;">Reset All Data</button>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
</body>
</html>
